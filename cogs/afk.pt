import discord
from discord import app_commands
from discord.ext import commands

class AFK(commands.Cog):
    def __init__(self, bot: commands.Bot):
        self.bot = bot
        self.afk_reasons = {}  # user_id -> reason

    @app_commands.command(name="afk", description="Set yourself as AFK")
    @app_commands.describe(reason="Optional reason for going AFK")
    async def afk_slash(self, interaction: discord.Interaction, reason: str = "AFK"):
        afk_role = interaction.guild.get_role(self.bot.afk_role_id)
        if not afk_role:
            await interaction.response.send_message("AFK role not found on this server.", ephemeral=True)
            return

        if afk_role in interaction.user.roles:
            await interaction.response.send_message("You're already marked as AFK.", ephemeral=True)
            return

        await interaction.user.add_roles(afk_role, reason=reason)
        self.afk_reasons[interaction.user.id] = reason

        embed = discord.Embed(
            description=f"{interaction.user.mention} is now AFK: {reason}",
            color=discord.Color.blue(),
            timestamp=discord.utils.utcnow()
        )
        if interaction.guild and interaction.guild.icon:
            embed.set_thumbnail(url=interaction.guild.icon.url)
        embed.set_footer(text="SWAT Roleplay Community")

        await interaction.response.send_message(embed=embed)

    async def cog_load(self):
        self.bot.tree.add_command(self.afk_slash)

async def setup(bot: commands.Bot):
    await bot.add_cog(AFK(bot))
